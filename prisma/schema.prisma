generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id               String          @id @default(cuid())
  name             String
  email            String          @unique
  passwordHash     String          @map("password_hash")
  role             String          @default("STRATEGIST")
  twoFactorEnabled Boolean         @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?         @map("two_factor_secret")
  createdAt        DateTime        @default(now()) @map("created_at")
  advisorActions   AdvisorReport[] @relation("reviewedBy")
  notificationClients Client[]     @relation("NotificationUsers")
  clients          Client[]        @relation("ClientAccess")

  @@map("users")
}

model Client {
  id                   String                 @id @default(cuid())
  name                 String
  industryType         String                 @map("industry_type")
  targetType           String                 @map("target_type")
  targetValue          Float                  @map("target_value")
  tolerancePct         Int                    @default(15) @map("tolerance_pct")
  evaluationWindowDays Int                    @default(7) @map("evaluation_window_days")
  profitMarginPct      Float?                 @map("profit_margin_pct")
  currency             String                 @default("EUR")
  createdAt            DateTime               @default(now()) @map("created_at")
  analystReports       AnalystReport[]
  campaignMetrics      CampaignMetric[]
  dataSources          DataSource[]
  merchantCenterHealth MerchantCenterHealth[]
  notifications        Notification[]
  incidents            Incident[]
  notificationUsers    User[]                 @relation("NotificationUsers")
  slackWebhookUrl      String?                @map("slack_webhook_url")
  users                User[]                 @relation("ClientAccess")
  clientInvites        ClientInvite[]

  @@map("clients")
}

model ClientInvite {
  id        String   @id @default(cuid())
  clientId  String   @map("client_id")
  email     String
  token     String   @unique
  status    String   @default("PENDING") // PENDING, ACCEPTED, REVOKED
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([token])
  @@index([email])
  @@map("client_invites")
}

model DataSource {
  id           String           @id @default(cuid())
  clientId     String           @map("client_id")
  type         String
  name         String?
  category     String           @default("DATA_SOURCE") // 'DATA_SOURCE' | 'APP'
  externalId   String           @map("external_id")
  config       Json?
  token        String           @map("token")
  active       Boolean          @default(true)
  linkedAt     DateTime         @default(now()) @map("linked_at")
  lastSyncedAt DateTime?        @map("last_synced_at")
  metrics      CampaignMetric[]
  uptimeChecks UptimeCheck[]
  client       Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  linkedAccounts LinkedAccount[]
  monitoredPages MonitoredPage[]
  incidents    Incident[]

  @@index([clientId, type])
  @@map("data_sources")
}

model UptimeCheck {
  id           String     @id @default(cuid())
  dataSourceId String     @map("data_source_id")
  status       String     // "UP" or "DOWN"
  responseTime Int        @map("response_time") // in ms
  statusCode   Int?       @map("status_code")
  checkedAt    DateTime   @default(now()) @map("checked_at")
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  @@index([dataSourceId, checkedAt])
  @@map("uptime_checks")
}

model CampaignMetric {
  id              String      @id @default(cuid())
  clientId        String      @map("client_id")
  campaignId      String      @map("campaign_id")
  campaignName    String      @map("campaign_name")
  campaignType    String      @map("campaign_type")
  date            DateTime
  spend           Float
  conversions     Float
  conversionValue Float       @map("conversion_value")
  clicks          Int
  impressions     Int
  status          String
  servingStatus   String      @map("serving_status")
  dataSourceId    String?     @map("data_source_id")
  dataSource      DataSource? @relation(fields: [dataSourceId], references: [id])
  client          Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([campaignId, date])
  @@index([clientId, date])
  @@index([campaignId, date])
  @@index([dataSourceId])
  @@map("campaign_metrics")
}

model MerchantCenterHealth {
  id               String   @id @default(cuid())
  clientId         String   @map("client_id")
  date             DateTime
  totalItems       Int      @map("total_items")
  disapprovedItems Int      @map("disapproved_items")
  disapprovedPct   Float    @map("disapproved_pct")
  topReasons       Json     @map("top_reasons")
  accountIssues    Json     @map("account_issues")
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, date])
  @@map("merchant_center_health")
}

model AnalystReport {
  id                   String         @id @default(cuid())
  clientId             String         @map("client_id")
  periodStart          DateTime       @map("period_start")
  periodEnd            DateTime       @map("period_end")
  healthScore          Int            @map("health_score")
  healthScoreBreakdown Json           @map("health_score_breakdown")
  deviationPct         Float          @map("deviation_pct")
  trendDirection       String         @map("trend_direction")
  reportJson           Json           @map("report_json")
  inputJson            Json           @map("input_json")
  createdAt            DateTime       @default(now()) @map("created_at")
  advisorReport        AdvisorReport?
  client               Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, createdAt])
  @@index([clientId, periodEnd])
  @@map("analyst_reports")
}

model AdvisorReport {
  id              String        @id @default(cuid())
  analystReportId String        @unique @map("analyst_report_id")
  adviceJson      Json          @map("advice_json")
  status          String        @default("DRAFT")
  reviewedById    String?       @map("reviewed_by_id")
  reviewedAt      DateTime?     @map("reviewed_at")
  executedAt      DateTime?     @map("executed_at")
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  reviewedBy      User?         @relation("reviewedBy", fields: [reviewedById], references: [id])
  analystReport   AnalystReport @relation(fields: [analystReportId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("advisor_reports")
}

model PromptLog {
  id         String   @id @default(cuid())
  type       String
  clientId   String   @map("client_id")
  inputJson  Json     @map("input_json")
  outputJson Json     @map("output_json")
  model      String
  tokenCount Int?     @map("token_count")
  latencyMs  Int?     @map("latency_ms")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([clientId, createdAt])
  @@index([type])
  @@map("prompt_logs")
}

model GlobalSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("global_settings")
}

model LinkedAccount {
  id           String     @id @default(cuid())
  dataSourceId String     @map("data_source_id")
  email        String
  name         String?
  role         String?
  status       String     @default("ACTIVE") // ACTIVE, REVOKED, PENDING
  kind         String     @default("USER")   // USER, MANAGER
  createdAt    DateTime   @default(now()) @map("created_at")
  dataSource   DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  @@unique([dataSourceId, email])
  @@index([email])
  @@map("linked_accounts")
}

model UserRole {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String   @default("#6366f1")
  roleMapping Json     @map("role_mapping")
  isDefault   Boolean  @default(false) @map("is_default")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("user_roles")
}

model Notification {
  id         String   @id @default(cuid())
  clientId   String   @map("client_id")
  type       String   // "STATUS_CODE_ERROR" | "DOWNTIME" | "SSL_EXPIRY"
  title      String
  message    String
  severity   String   @default("warning") // "info" | "warning" | "critical"
  read       Boolean  @default(false)
  url        String?  // monitored URL that triggered this
  statusCode Int?     @map("status_code")
  createdAt  DateTime @default(now()) @map("created_at")
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, read, createdAt])
  @@index([clientId, url, statusCode, read])
  @@map("notifications")
}

model MonitoredPage {
  id            String     @id @default(cuid())
  dataSourceId  String     @map("data_source_id")
  url           String     // path or full URL to check
  label         String?    // optional display name
  active        Boolean    @default(true)
  lastStatus    Int?       @map("last_status")
  lastCheckedAt DateTime?  @map("last_checked_at")
  dataSource    DataSource @relation(fields: [dataSourceId], references: [id], onDelete: Cascade)

  @@index([dataSourceId])
  @@map("monitored_pages")
}

model Incident {
  id              String          @id @default(cuid())
  clientId        String          @map("client_id")
  dataSourceId    String?         @map("data_source_id")
  title           String          // e.g. "evalco.nl/deadfaf"
  cause           String          // e.g. "Status 404"
  causeCode       String?         @map("cause_code") // "404", "T/O", "503"
  status          String          @default("ONGOING") // ONGOING | ACKNOWLEDGED | RESOLVED
  checkedUrl      String?         @map("checked_url")
  httpMethod      String          @default("GET") @map("http_method")
  statusCode      Int?            @map("status_code")
  responseTime    Float?          @map("response_time")
  resolvedIp      String?         @map("resolved_ip")
  startedAt       DateTime        @default(now()) @map("started_at")
  acknowledgedAt  DateTime?       @map("acknowledged_at")
  acknowledgedBy  String?         @map("acknowledged_by")
  resolvedAt      DateTime?       @map("resolved_at")
  resolvedBy      String?         @map("resolved_by")
  createdAt       DateTime        @default(now()) @map("created_at")
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dataSource      DataSource?     @relation(fields: [dataSourceId], references: [id], onDelete: SetNull)
  events          IncidentEvent[]

  @@index([clientId, status])
  @@index([dataSourceId])
  @@index([startedAt])
  @@map("incidents")
}

model IncidentEvent {
  id         String   @id @default(cuid())
  incidentId String   @map("incident_id")
  type       String   // CREATED | ACKNOWLEDGED | RESOLVED | ESCALATED | COMMENT
  message    String?
  userId     String?  @map("user_id")
  userName   String?  @map("user_name")
  createdAt  DateTime @default(now()) @map("created_at")
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId, createdAt])
  @@map("incident_events")
}

